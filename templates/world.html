{% extends "base.html" %}
{% block head %}
<style>
  :root{
    --tabbar-h:60px;
    --sab: env(safe-area-inset-bottom, 0px);
    --controls-gap: clamp(84px, 20vh, 160px);
    --card-bg: rgba(16,18,24,.92);
    --card-brd: rgba(255,255,255,.10);
    --shadow: 0 12px 28px rgba(0,0,0,.45);
  }

  .card{ background:var(--card-bg); border:1px solid var(--card-brd);
         border-radius:16px; box-shadow:var(--shadow) }
  .card.hud{ position:sticky; top:0; z-index:20; padding:12px; backdrop-filter: blur(8px) }

  .row{ display:flex; align-items:center; gap:8px }
  .row.wrap{ flex-wrap:wrap }
  .row.space{ justify-content:space-between }

  .pill{ font-size:12px; line-height:1; padding:6px 10px; border-radius:999px;
         background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10) }
  .stat b{ font-variant-numeric: tabular-nums }

  .pill.wide{ min-width:0; flex:1 1 180px; white-space:normal; }
  .wx-detail{ margin-top:8px; }
  .wx-detail .pill{ font-size:11px; }
  .load-row{ margin-top:6px; }
  .pill.load-tier[data-tier="light"]{ background:rgba(34,197,94,.14); border-color:rgba(34,197,94,.35); }
  .pill.load-tier[data-tier="steady"]{ background:rgba(59,130,246,.14); border-color:rgba(59,130,246,.35); }
  .pill.load-tier[data-tier="strained"]{ background:rgba(249,115,22,.14); border-color:rgba(249,115,22,.35); }
  .pill.load-tier[data-tier="overloaded"]{ background:rgba(248,113,113,.16); border-color:rgba(248,113,113,.35); }
  .pill.load-tier[data-tier="encumbered"]{ background:rgba(239,68,68,.25); border-color:rgba(239,68,68,.55); }

  .btn.mine.gather-active{ background:#ef4444; }

  .bar{ height:12px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden }
  .bar .fill{ height:100%; background:#4ca6ff }

  /* –ö–∞—Ä—Ç–∞ */
  .card.map{ padding:10px; }
  .mapwrap{ border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.08) }
  svg{ width:100%; height:auto; display:block; touch-action:manipulation; user-select:none }
  #cam{ will-change: transform }
  .me{ stroke:#fff; stroke-width:1.2 }
  .aim{ fill:none; stroke:#ffcd4d; stroke-width:1.2; stroke-dasharray: 4 3 }
  .hover{ fill: rgba(255,255,255,.06); stroke: rgba(255,255,255,.25); stroke-width: 1 }

  .card.encounters{ padding:12px; }
  .enc-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .enc-head .subtitle{ font-size:12px; opacity:.85; }
  .enc-list{ display:flex; flex-direction:column; gap:8px; }
  .monster-row{ display:flex; align-items:center; justify-content:space-between; gap:12px;
                padding:10px 12px; border-radius:12px; background:rgba(255,255,255,.06);
                border:1px solid rgba(255,255,255,.12); }
  .monster-row.boss{ border-color:rgba(249,115,22,.45); box-shadow:0 0 0 1px rgba(249,115,22,.25) inset; }
  .monster-row .meta{ display:flex; flex-direction:column; gap:4px; }
  .monster-row .title{ font-weight:800; font-size:15px; display:flex; align-items:center; gap:6px; }
  .monster-row .tags{ font-size:12px; opacity:.85; display:flex; gap:6px; flex-wrap:wrap; }
  .monster-row .actions{ display:flex; gap:8px; }
  .monster-row .actions .btn{ min-height:0; padding:10px 14px; font-size:13px; }
  .monster-row .pill{ font-size:11px; }

  .card.combat{ padding:12px; }
  .card.combat.hidden{ display:none; }
  .combat-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .combat-header .pill{ font-size:12px; }
  .combat-bars{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
  .combat-bar{ display:flex; align-items:center; gap:10px; }
  .combat-bar .label{ font-weight:800; min-width:74px; }
  .hp-bar{ flex:1; height:12px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; }
  .hp-bar .fill{ height:100%; width:100%; background:#22c55e; }
  .hp-bar.monster .fill{ background:#f87171; }
  .combat-bar .hp-num{ font-variant-numeric:tabular-nums; font-size:12px; }
  .combat-actions{ display:flex; gap:10px; margin-bottom:10px; }
  .btn.combat{ flex:1; font-size:15px; }
  .btn.combat.attack{ background:#ef4444; }
  .btn.combat.flee{ background:#6b7280; }
  .combat-log{ max-height:200px; overflow:auto; display:flex; flex-direction:column; gap:6px; font-size:13px; }
  .combat-log .entry{ padding:6px 8px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); }
  .combat-log .entry.player{ border-color:rgba(96,165,250,.35); }
  .combat-log .entry.monster{ border-color:rgba(248,113,113,.35); }
  .combat-log .entry.system{ opacity:.85; }

  /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π */
  .controls{
    position: fixed; left:0; right:0;
    bottom: calc(var(--tabbar-h) + var(--controls-gap) + var(--sab));
    z-index: 90;
  }
  .controls .wrap{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    background:rgba(0,0,0,.45); backdrop-filter: blur(12px);
    padding:12px; border-radius:16px; margin:10px;
    border:1px solid rgba(255,255,255,.12);
  }
  .btn{
    background:#1f6feb; color:#fff; border:0; border-radius:14px;
    padding:14px 16px; font-weight:800;
    font-size: clamp(15px, 2.6vw, 17px);
    min-height: 48px; min-width: 88px;
  }
  .btn:active{ transform: translateY(1px) }
  .btn.go{ background:#34d399; flex:1 }
  .btn.stop{ background:#ff4d67; flex:1 }
  .btn.camp{
    background:linear-gradient(180deg,#f1c35a 0%,#e9a92e 100%); color:#1b1202;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.25); min-width:126px
  }
  /* –Ω–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±—ã—á–∏ */
  .btn.mine{ background:#a78bfa; }

  .mini-spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.28);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;margin-right:6px;vertical-align:-2px}
  @keyframes spin{to{transform:rotate(1turn)}}
  .pill.moving{background:rgba(76,166,255,.16)}
  .pill.resting{background:rgba(52,211,153,.16)}
  .pill.idle{background:rgba(255,255,255,.10)}

  /* –ë–∞–Ω–Ω–µ—Ä —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥—ã */
  .wx-banner{
    display:flex; align-items:center; gap:10px;
    margin-top:10px; padding:10px 12px; border-radius:12px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
    font-size:14px; line-height:1.2;
  }
  .wx-banner .ico{ font-size:18px }
  .wx-banner .text b{ font-weight:800 }
  
  /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
  .tabbar{
    position: fixed; left:0; right:0; bottom:0;
    height: calc(var(--tabbar-h) + var(--sab)); padding-bottom: var(--sab);
    z-index: 80;
    background: rgba(0,0,0,.88); backdrop-filter: blur(12px);
    border-top:1px solid rgba(255,255,255,.12);
    display:flex; align-items:center; justify-content:space-around;
  }
  .tabbar .tab{
    display:flex; flex-direction:column; align-items:center; gap:6px;
    color:#fff; opacity:.95; background:transparent; border:0; cursor:pointer;
    font: 700 12px/1 system-ui,Segoe UI,Roboto;
    padding:10px 12px; border-radius:12px;
    min-width: 92px; min-height: 44px;
  }
  .tabbar .tab .ico{ font-size:20px; line-height:20px }
  .tabbar .tab.active{ background:rgba(255,255,255,.10) }

  #uiFab, .ui-dock{ display:none !important }
</style>
{% endblock %}

{% block content %}

<!-- ======= HUD ======= -->
<section class="card hud" id="hudRoot" aria-label="–°–æ—Å—Ç–æ—è–Ω–∏–µ">
  <div class="row wrap" id="chipsRow">
    <span class="pill">x:<b id="px">0</b> y:<b id="py">0</b></span>

    <span class="pill idle" id="movePill">
      <span class="mini-spinner" id="moveSpin" style="display:none"></span>
      <b id="moveText">–°—Ç–æ–∏—Ç</b>
    </span>

    <span class="pill">–¢–∞–π–ª: <b id="tileRu">‚Äî</b></span>
    <span class="pill" id="effects">–≠—Ñ—Ñ–µ–∫—Ç—ã: ‚Äî</span>
  </div>

  <!-- –ë–∞–Ω–Ω–µ—Ä ¬´–ü–æ–≥–æ–¥–∞ —Å–µ–π—á–∞—Å ‚Ä¶¬ª -->
  <div class="wx-banner" id="wxBanner" aria-live="polite">
    <span class="ico" id="wxIcon">üå§Ô∏è</span>
    <span class="text">–°–µ–π—á–∞—Å ‚Äî <b id="wNowInline">‚Äî</b></span>
  </div>

  <div class="row space" style="margin-top:10px">
    <div class="pill">–£—Å—Ç–∞–ª–æ—Å—Ç—å: <b id="fat">0</b></div>
    <div style="min-width:160px; flex:1; margin-left:10px">
      <div class="bar"><div class="fill" id="fatFill" style="width:0%"></div></div>
    </div>
  </div>

  <div class="row wrap wx-detail" id="wxMetricsRow">
    <span class="pill">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: <b id="wxTemp">‚Äî</b></span>
    <span class="pill">–û—â—É—â–∞–µ—Ç—Å—è: <b id="wxFeels">‚Äî</b></span>
    <span class="pill">–í–ª–∞–∂–Ω–æ—Å—Ç—å: <b id="wxHumidity">‚Äî</b></span>
    <span class="pill">–í–µ—Ç–µ—Ä: <b id="wxWind">‚Äî</b></span>
    <span class="pill">–í–∏–¥–∏–º–æ—Å—Ç—å: <b id="wxVisibility">‚Äî</b></span>
    <span class="pill" id="wxComfort">–ö–æ–º—Ñ–æ—Ä—Ç: ‚Äî</span>
  </div>

  <div class="row wrap wx-detail">
    <span class="pill wide" id="wxModifiers">‚Äî</span>
    <span class="pill wide" id="wxExplain">‚Äî</span>
  </div>

  <div class="row wrap load-row" id="loadRow">
    <span class="pill">–í–µ—Å: <b id="invWeightHud">0</b>/<b id="invCapacityHud">0</b> –∫–≥</span>
    <span class="pill">–ù–∞–≥—Ä—É–∑–∫–∞: <b id="invLoadPctHud">0%</b></span>
    <span class="pill load-tier" id="invLoadTier">‚Äî</span>
  </div>
</section>

<!-- ======= MAP ======= -->
<section class="card map" id="view-map" aria-label="–ö–∞—Ä—Ç–∞">
  <div class="mapwrap">
    <svg id="map" viewBox="0 0 270 162" preserveAspectRatio="xMidYMin meet">
      {% include "_world_defs.html" %}
      <g id="cam">
        <g id="tiles"></g>
        <g id="blds"></g>
        <g id="hover"></g>
        <g id="aim"></g>
        <g id="me"></g>
      </g>
    </svg>
  </div>
  <div class="hint" style="margin:10px 6px 6px">–¢–∞–ø–Ω–∏ –ø–æ –∫–∞—Ä—Ç–µ ‚Üí ¬´–ò–¥—Ç–∏¬ª. –£–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ –∫–∞—Ä—Ç–µ ‚Äî ¬´–°—Ç–æ–ø¬ª.</div>
</section>

<div style="height:140px" aria-hidden="true"></div>

<!-- ======= –ú–æ–Ω—Å—Ç—Ä—ã –∏ –±–æ–π ======= -->
<section class="card encounters" id="encounterCard" aria-label="–ú–æ–Ω—Å—Ç—Ä—ã –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏">
  <div class="enc-head">
    <b>–ú–æ–Ω—Å—Ç—Ä—ã –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏</b>
    <span class="subtitle" id="encSummary">–°–ø–æ–∫–æ–π–Ω–æ</span>
  </div>
  <div class="enc-list" id="encounterList">
    <div class="tiny">–ü–æ–±–ª–∏–∑–æ—Å—Ç–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç.</div>
  </div>
</section>

<section class="card combat hidden" id="combatCard" aria-label="–¢–µ–∫—É—â–∏–π –±–æ–π">
  <div class="combat-header">
    <b id="combatTitle">–ë–æ–π</b>
    <span class="pill" id="combatStatus">‚Äî</span>
  </div>
  <div class="combat-bars">
    <div class="combat-bar">
      <span class="label">–í—ã</span>
      <div class="hp-bar" id="combatPlayerBar"><div class="fill" id="combatPlayerHP"></div></div>
      <span class="hp-num" id="combatPlayerNum">0 / 0</span>
    </div>
    <div class="combat-bar">
      <span class="label" id="combatMonsterLabel">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</span>
      <div class="hp-bar monster" id="combatMonsterBar"><div class="fill" id="combatMonsterHP"></div></div>
      <span class="hp-num" id="combatMonsterNum">0 / 0</span>
    </div>
  </div>
  <div class="combat-actions">
    <button class="btn combat attack" id="combatAttackBtn" type="button">‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å</button>
    <button class="btn combat flee" id="combatFleeBtn" type="button">üèÉ‚Äç‚ôÇÔ∏è –û—Ç—Å—Ç—É–ø–∏—Ç—å</button>
  </div>
  <div class="combat-log" id="combatLog">
    <div class="entry system">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∂—É—Ä–Ω–∞–ª –±–æ—è.</div>
  </div>
</section>

<!-- ======= –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π ======= -->
<section class="controls" id="controlsBar" aria-label="–î–µ–π—Å—Ç–≤–∏—è">
  <div class="wrap">
    <button class="btn stop" id="btnStop" type="button">–°—Ç–æ–ø</button>
    <button class="btn go"   id="btnGo"   type="button">–ò–¥—Ç–∏</button>
    <button class="btn mine" id="btnGather" type="button">‚õèÔ∏è –î–æ–±—ã–≤–∞—Ç—å</button>  <!-- NEW -->
    <button class="btn camp" id="btnCamp" type="button">üèïÔ∏è –õ–∞–≥–µ—Ä—å</button>
  </div>
</section>
<div class="gather-mode-bar" id="gatherModeBar" role="group" aria-label="–†–µ–∂–∏–º –¥–æ–±—ã—á–∏"></div>

<!-- ======= –Ω–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è ======= -->
<nav class="tabbar" id="tabbar" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
  <button class="tab active" data-action="map" type="button"
          aria-selected="true"
          onclick="window.WorldUI && window.WorldUI.close()">
    <span class="ico">üó∫Ô∏è</span><span>–ö–∞—Ä—Ç–∞</span>
  </button>

  <button class="tab" data-action="profile" data-href="/accounts/profile" type="button"
          onclick="(window.WorldUI&&window.WorldUI.open)?window.WorldUI.open('profile'):location.assign('/accounts/profile')">
    <span class="ico">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
  </button>

  <button class="tab" data-action="inv" type="button"
          onclick="window.WorldUI && window.WorldUI.open('inv')">
    <span class="ico">üéí</span><span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
  </button>
  <button class="tab" data-action="craft" type="button"
          onclick="window.WorldUI && window.WorldUI.open('craft')">
    <span class="ico">üî®</span><span>–ö—Ä–∞—Ñ—Ç</span>
  </button>
</nav>
<div id="uiInvList"><div class="tiny">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>

<script>
  // –ù–∞–≤–∏–≥–∞—Ü–∏—è
  window.addEventListener('DOMContentLoaded', () => {
    const bar = document.getElementById('tabbar');
    if (!bar) return;
    const setActive = (btn)=>bar.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b===btn));
    bar.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab'); if (!btn) return;
      setActive(btn);
      const act = btn.dataset.action;
      if (act === 'map') {
        window.WorldUI && window.WorldUI.close();
      } else if (act === 'profile') {
        if (window.WorldUI && window.WorldUI.open) window.WorldUI.open('profile');
        else if (btn.dataset.href) location.assign(btn.dataset.href);
      } else if (act === 'inv') {
        window.WorldUI && window.WorldUI.open('inv');
      }
    });
  });
</script>

<div id="diagOverlay"><div class="box" id="diagBox"></div></div>

<script>
  window.WORLD_BOOT = {
    tileVersions: {{ tile_versions|tojson|safe }},
    endpoints: {
      state: "{{ url_for('world.api_state') }}",
      setDest: "{{ url_for('world.api_set_dest') }}",
      stop: "{{ url_for('world.api_stop') }}",
      campStart: "{{ url_for('world.api_camp_start') }}",
      campLeave: "{{ url_for('world.api_camp_leave') }}",
      tileVersions: "{{ url_for('world.tile_versions_json') }}",
      patchView: "{{ url_for('world.api_patch') }}",
      stateGet: "{{ state_get_url|default('') }}",

      /* –¥–æ–±—ã—á–∞ ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ endpoints —É –±–ª—é–ø—Ä–∏–Ω—Ç–∞ world_resources */
      gatherStart: "{{ url_for('world_resources.gather_start') }}",
      gatherStop:  "{{ url_for('world_resources.gather_stop') }}",
      gatherTick:  "{{ url_for('world_resources.gather_tick') }}",

      combatState: "{{ url_for('world_combat.combat_state') }}",
      combatEngage: "{{ url_for('world_combat.combat_engage') }}",
      combatAttack: "{{ url_for('world_combat.combat_attack') }}",
      combatFlee: "{{ url_for('world_combat.combat_flee') }}"
    },
    gatherModes: {{ gather_modes|tojson|safe }},
    gatherDefaultMode: "{{ gather_default_mode }}"
  };
</script>

<script defer src="{{ url_for('static', filename='js/world_client.js') }}?v={{ static_v }}"></script>
<script defer src="{{ url_for('static', filename='js/combat_client.js') }}?v={{ static_v }}"></script>
<script defer src="{{ url_for('static', filename='js/world_ui.js') }}?v={{ static_v }}"></script>
<!-- –Ω–æ–≤—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–º–æ–¥—É–ª—å –¥–æ–±—ã—á–∏ -->
<script defer src="{{ url_for('static', filename='js/gather_client.js') }}?v={{ static_v }}"></script>
<!-- –∫—Ä–∞—Ñ—Ç —Å–∏—Å—Ç–µ–º–∞ -->
<script defer src="{{ url_for('static', filename='js/craft_client.js') }}?v={{ static_v }}"></script>
{% endblock %}
