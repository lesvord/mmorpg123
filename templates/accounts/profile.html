{% extends "base.html" %}
{% block head %}
<style>
  :root{ --sab: env(safe-area-inset-bottom, 0px); }
  .container{ padding:12px; padding-bottom: calc(16px + var(--sab)); }
  .card{ background:rgba(16,18,24,.92); border:1px solid rgba(255,255,255,.12);
         border-radius:16px; box-shadow:0 12px 28px rgba(0,0,0,.45); padding:12px; margin-bottom:12px }
  .h{ margin:0 0 6px; font-weight:800 }
  .kv{ display:flex; justify-content:space-between; gap:12px; align-items:center; margin:6px 0 }
  .kv b{ font-variant-numeric:tabular-nums }
  .badge{ padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08) }
  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px }
  .bar{ height:12px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; margin:6px 0 }
  .bar .fill{ height:100%; background:#4ca6ff; width: 0% }
  .actions{ position:sticky; bottom:0; display:flex; gap:10px; padding-top:8px; background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0)); }
  .btn{ background:#1f6feb; color:#fff; border:0; border-radius:14px; padding:14px 16px; font-weight:800; flex:1; text-align:center; display:inline-block; text-decoration:none }
  .btn.ghost{ background:rgba(255,255,255,.10) }
  .tiny{ opacity:.8; font-size:12px }
  .list{ display:flex; flex-direction:column; gap:8px; margin-top:6px }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10) }
  .row .meta{ display:flex; gap:10px; align-items:baseline }
  .row .meta .name{ font-weight:700 }
  .row .meta .sub{ font-size:12px; opacity:.85 }
  .row .drop{ background:rgba(255,255,255,.12); border:0; border-radius:10px; padding:8px 10px; color:#fff; font-weight:700; cursor:pointer }
</style>
{% endblock %}

{% block content %}
<div class="container">

  <section class="card">
    <h2 class="h">–ü—Ä–æ—Ñ–∏–ª—å</h2>
    <div class="kv"><span>–ù–∏–∫</span><b>{{ user.username }}</b></div>
    <div class="kv"><span>Email</span><b>{{ user.email }}</b></div>
  </section>

  <section class="grid">
    {% set combat = profile.combat_snapshot() %}
    <div class="card">
      <b>–°—Ç–∞—Ç—ã</b>
      <div class="kv"><span>–£—Ä–æ–≤–µ–Ω—å</span><b>{{ profile.level }}</b></div>
      <div class="kv"><span>–û–ø—ã—Ç</span><b>{{ profile.xp }} / {{ profile.xp_to_next() }}</b></div>
      <div class="bar" aria-hidden="true"><div class="fill" style="width: {{ ((profile.xp / profile.xp_to_next()) * 100) if profile.xp_to_next() > 0 else 0 }}%"></div></div>
      <div class="kv"><span>–°–∏–ª–∞</span><b>{{ profile.str_ }}</b></div>
      <div class="kv"><span>–õ–æ–≤–∫–æ—Å—Ç—å</span><b>{{ profile.agi }}</b></div>
      <div class="kv"><span>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</span><b>{{ profile.int_ }}</b></div>
      <div class="kv"><span>–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</span><b>{{ profile.vit }}</b></div>
      <div class="kv"><span>–ó–∞—â–∏—Ç–∞</span><b>{{ profile.defense }}</b></div>
      <div class="kv"><span>–£–¥–∞—á–∞</span><b>{{ profile.luck }}</b></div>
      <div class="kv"><span>–ó–æ–ª–æ—Ç–æ</span><b>{{ profile.gold|int }}</b></div>
      <hr style="border:0;border-top:1px solid rgba(255,255,255,.08);margin:8px 0">
      <div class="kv"><span>–ú–∞–∫—Å. –∑–¥–æ—Ä–æ–≤—å–µ</span><b>{{ combat.hp_max }}</b></div>
      <div class="kv"><span>–ê—Ç–∞–∫–∞</span><b>{{ combat.attack }}</b></div>
      <div class="kv"><span>–ó–∞—â–∏—Ç–∞ (–±–æ–µ–≤.)</span><b>{{ combat.defense }}</b></div>
      <div class="kv"><span>–ö—Ä–∏—Ç. —à–∞–Ω—Å</span><b>{{ (combat.crit * 100)|round(1) }}%</b></div>
      <div class="kv"><span>–£–∫–ª–æ–Ω–µ–Ω–∏–µ</span><b>{{ (combat.dodge * 100)|round(1) }}%</b></div>
    </div>

    <div class="card">
      <b>–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</b>
      {% if equipped %}
        {% for slot, row in equipped.items() %}
          <div class="kv"><span class="badge">{{ slot }}</span><b>{{ row.item.name }}</b></div>
        {% endfor %}
      {% else %}
        <div class="tiny">–ü—É—Å—Ç–æ</div>
      {% endif %}
    </div>
  </section>

  <!-- –ù–û–í–û–ï: –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
  <section class="card" id="invCard">
    <b>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</b>
    <div class="kv"><span>–í–µ—Å</span><b><span id="invWeight">0</span> / <span id="invCap">30</span> –∫–≥</b></div>
    <div class="bar" aria-hidden="true"><div class="fill" id="invFill"></div></div>
    <div class="list" id="invList"><div class="tiny">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
  </section>

  <div class="actions">
    <a class="btn ghost" href="javascript:history.back()">–ù–∞–∑–∞–¥</a>
    <a class="btn" href="/play">–í –∏–≥—Ä—É</a>
  </div>
</div>

<script>
  // Back –≤ Telegram Mini App
  try{
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.BackButton.show();
      Telegram.WebApp.BackButton.onClick(function(){
        if (document.referrer) history.back(); else location.href = '/play';
      });
    }
  }catch(e){}

  // ====== –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: –∑–∞–≥—Ä—É–∑–∫–∞/—Ä–µ–Ω–¥–µ—Ä/–≤—ã–±—Ä–æ—Å ======
  async function invGET(){
    const r = await fetch('/inv/api/list', {headers:{'Cache-Control':'no-cache'}});
    const j = await r.json().catch(()=>({ok:false}));
    return j;
  }
  async function invDROP(invId, qty){
    const r = await fetch('/inv/api/drop', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({inv_id: invId, qty})
    });
    const j = await r.json().catch(()=>({ok:false}));
    return j;
  }
  function renderInv(j){
    const list = document.getElementById('invList');
    const wEl = document.getElementById('invWeight');
    const cEl = document.getElementById('invCap');
    const fill = document.getElementById('invFill');

    if (!j || !j.ok){ list.innerHTML = '<div class="tiny">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>'; return; }

    const totals = j.totals || {};
    const counts = j.counts || {};
    const items = Array.isArray(j.items) ? j.items : [];

    wEl.textContent = fixed(totals.weight_kg || 0);
    cEl.textContent = fixed(totals.capacity_kg || 0);
    const perc = Math.max(0, Math.min(100, Number(totals.load_pct || 0)));
    fill.style.width = perc.toFixed(0) + '%';

    if (!items.length){
      list.innerHTML = '<div class="tiny">–ü—É—Å—Ç–æ</div>';
      return;
    }

    list.innerHTML = '';
    items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'row';
      const left = document.createElement('div');
      left.className = 'meta';
      const nm = document.createElement('div');
      nm.className = 'name';
      const nameTxt = it.name || it.item_key;
      nm.textContent = `${nameTxt} √ó${it.qty || 1}`;
      const icon = document.createElement('span');
      icon.className = 'ico';
      icon.textContent = emojiFor(it.item_key || it.name || '');
      icon.style.marginRight = '6px';
      icon.style.display = 'inline-block';
      nm.prepend(icon);
      const sub = document.createElement('div');
      sub.className = 'sub';
      const totalWeight = (it.total_weight != null) ? it.total_weight : (it.weight_kg || 0) * (it.qty || 1);
      sub.textContent = `${fixed(it.weight_kg || 0)} –∫–≥/—à—Ç ¬∑ –≤—Å–µ–≥–æ ${fixed(totalWeight)} –∫–≥`;
      left.appendChild(nm); left.appendChild(sub);

      const btn = document.createElement('button');
      btn.className = 'drop';
      btn.textContent = '–í—ã–±—Ä–æ—Å–∏—Ç—å';
      btn.addEventListener('click', async()=>{
        const maxQ = it.qty || 1;
        const val = prompt(`–°–∫–æ–ª—å–∫–æ –≤—ã–±—Ä–æ—Å–∏—Ç—å? (1..${maxQ})`, String(Math.min(1, maxQ)));
        if (!val) return;
        const q = Math.max(1, Math.min(maxQ, parseInt(val,10)||1));
        const res = await invDROP(it.inv_id, q);
        if (!res || !res.ok){ alert(res && res.message ? res.message : '–û—à–∏–±–∫–∞'); return; }
        loadInv();
      });

      row.appendChild(left); row.appendChild(btn);
      list.appendChild(row);
    });
  }
  function emojiFor(key){
    const k = String(key||'').toLowerCase();
    if (k.includes('wood') || k.includes('stick')) return 'ü™µ ';
    if (k.includes('ore') || k.includes('stone') || k.includes('gem')) return 'ü™® ';
    if (k.includes('fish')) return 'üêü ';
    if (k.includes('berry')) return 'ü´ê ';
    if (k.includes('mush')) return 'üçÑ ';
    if (k.includes('herb') || k.includes('fiber')) return 'üåø ';
    if (k.includes('ice')) return 'üßä ';
    if (k.includes('cactus')) return 'üåµ ';
    return '';
  }

  function fixed(val){
    return (Math.round(Number(val||0)*100)/100).toFixed(2).replace(/\.00$/,'');
  }

  async function loadInv(){ const j = await invGET(); renderInv(j); }
  document.addEventListener('DOMContentLoaded', loadInv);
</script>
{% endblock %}
