{% extends "base.html" %}
{% block head %}
<style>
  :root{ --sab: env(safe-area-inset-bottom, 0px); }
  .container{ padding:12px; padding-bottom: calc(16px + var(--sab)); }
  .card{ background:rgba(16,18,24,.92); border:1px solid rgba(255,255,255,.12);
         border-radius:16px; box-shadow:0 12px 28px rgba(0,0,0,.45); padding:12px; margin-bottom:12px }
  .h{ margin:0 0 6px; font-weight:800 }
  .kv{ display:flex; justify-content:space-between; gap:12px; align-items:center; margin:6px 0 }
  .kv b{ font-variant-numeric:tabular-nums }
  .badge{ padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08) }
  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px }
  .bar{ height:12px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; margin:6px 0 }
  .bar .fill{ height:100%; background:#4ca6ff; width: 0% }
  .actions{ position:sticky; bottom:0; display:flex; gap:10px; padding-top:8px; background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0)); }
  .btn{ background:#1f6feb; color:#fff; border:0; border-radius:14px; padding:14px 16px; font-weight:800; flex:1; text-align:center; display:inline-block; text-decoration:none }
  .btn.ghost{ background:rgba(255,255,255,.10) }
  .tiny{ opacity:.8; font-size:12px }
  .list{ display:flex; flex-direction:column; gap:8px; margin-top:6px }
  .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10) }
  .row .meta{ display:flex; gap:10px; align-items:baseline }
  .row .meta .name{ font-weight:700 }
  .row .meta .sub{ font-size:12px; opacity:.85 }
  .row .drop{ background:rgba(255,255,255,.12); border:0; border-radius:10px; padding:8px 10px; color:#fff; font-weight:700; cursor:pointer }
</style>
{% endblock %}

{% block content %}
<div class="container">

  <section class="card">
    <h2 class="h">Профиль</h2>
    <div class="kv"><span>Ник</span><b>{{ user.username }}</b></div>
    <div class="kv"><span>Email</span><b>{{ user.email }}</b></div>
  </section>

  <section class="grid">
    <div class="card">
      <b>Статы</b>
      <div class="kv"><span>Уровень</span><b>{{ profile.level }}</b></div>
      <div class="kv"><span>Опыт</span><b>{{ profile.xp }} / {{ profile.xp_to_next() }}</b></div>
      <div class="bar" aria-hidden="true"><div class="fill" style="width: {{ ((profile.xp / profile.xp_to_next()) * 100) if profile.xp_to_next() > 0 else 0 }}%"></div></div>
      <div class="kv"><span>Сила</span><b>{{ profile.str_ }}</b></div>
      <div class="kv"><span>Ловкость</span><b>{{ profile.agi }}</b></div>
      <div class="kv"><span>Интеллект</span><b>{{ profile.int_ }}</b></div>
      <div class="kv"><span>Выносливость</span><b>{{ profile.vit }}</b></div>
      <div class="kv"><span>Удача</span><b>{{ profile.luck }}</b></div>
      <div class="kv"><span>Золото</span><b>{{ profile.gold|int }}</b></div>
    </div>

    <div class="card">
      <b>Экипировка</b>
      {% if equipped %}
        {% for slot, row in equipped.items() %}
          <div class="kv"><span class="badge">{{ slot }}</span><b>{{ row.item.name }}</b></div>
        {% endfor %}
      {% else %}
        <div class="tiny">Пусто</div>
      {% endif %}
    </div>
  </section>

  <!-- НОВОЕ: Инвентарь -->
  <section class="card" id="invCard">
    <b>Инвентарь</b>
    <div class="kv"><span>Вес</span><b><span id="invWeight">0</span> / <span id="invCap">30</span> кг</b></div>
    <div class="bar" aria-hidden="true"><div class="fill" id="invFill"></div></div>
    <div class="list" id="invList"><div class="tiny">Загрузка…</div></div>
  </section>

  <div class="actions">
    <a class="btn ghost" href="javascript:history.back()">Назад</a>
    <a class="btn" href="/play">В игру</a>
  </div>
</div>

<script>
  // Back в Telegram Mini App
  try{
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.BackButton.show();
      Telegram.WebApp.BackButton.onClick(function(){
        if (document.referrer) history.back(); else location.href = '/play';
      });
    }
  }catch(e){}

  // ====== Инвентарь: загрузка/рендер/выброс ======
  async function invGET(){
    const r = await fetch('/world/inventory', {headers:{'Cache-Control':'no-cache'}});
    const j = await r.json().catch(()=>({ok:false}));
    return j;
  }
  async function invDROP(key, qty){
    const r = await fetch('/world/inventory/drop', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({key, qty})
    });
    const j = await r.json().catch(()=>({ok:false}));
    return j;
  }
  function renderInv(j){
    const list = document.getElementById('invList');
    const wEl = document.getElementById('invWeight');
    const cEl = document.getElementById('invCap');
    const fill = document.getElementById('invFill');

    if (!j || !j.ok){ list.innerHTML = '<div class="tiny">Не удалось загрузить инвентарь</div>'; return; }

    wEl.textContent = (j.weight||0).toFixed(2);
    cEl.textContent = (j.cap||30).toFixed(0);
    const perc = Math.max(0, Math.min(100, (j.weight||0)/(j.cap||1)*100));
    fill.style.width = perc.toFixed(0) + '%';

    if (!j.items || !j.items.length){
      list.innerHTML = '<div class="tiny">Пусто</div>';
      return;
    }

    list.innerHTML = '';
    j.items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'row';
      const left = document.createElement('div');
      left.className = 'meta';
      const nm = document.createElement('div');
      nm.className = 'name';
      nm.textContent = it.name || it.key;
      const sub = document.createElement('div');
      sub.className = 'sub';
      const w = (it.weight || 0)* (it.qty || 1);
      sub.textContent = `x${it.qty || 1} · ${w.toFixed(2)} кг`;
      left.appendChild(nm); left.appendChild(sub);

      const btn = document.createElement('button');
      btn.className = 'drop';
      btn.textContent = 'Выбросить';
      btn.addEventListener('click', async()=>{
        const maxQ = it.qty || 1;
        const val = prompt(`Сколько выбросить? (1..${maxQ})`, String(Math.min(1, maxQ)));
        if (!val) return;
        const q = Math.max(1, Math.min(maxQ, parseInt(val,10)||1));
        const res = await invDROP(it.key, q);
        if (!res || !res.ok){ alert(res && res.message ? res.message : 'Ошибка'); return; }
        loadInv();
      });

      row.appendChild(left); row.appendChild(btn);
      list.appendChild(row);
    });
  }
  async function loadInv(){ const j = await invGET(); renderInv(j); }
  document.addEventListener('DOMContentLoaded', loadInv);
</script>
{% endblock %}
